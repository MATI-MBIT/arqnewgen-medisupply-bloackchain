# AlchemyWebSocketMicro Makefile

.PHONY: help build run test clean docker-build docker-run docker-stop deps fmt vet

# Variables
APP_NAME=alchemy-websocket-micro
DOCKER_IMAGE=$(APP_NAME)
PORT=8081

help: ## Mostrar ayuda
	@echo "Comandos disponibles:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-15s\033[0m %s\n", $$1, $$2}'

deps: ## Instalar dependencias
	@echo "ğŸ“¦ Instalando dependencias..."
	go mod download
	go mod tidy

fmt: ## Formatear cÃ³digo
	@echo "ğŸ¨ Formateando cÃ³digo..."
	go fmt ./...

vet: ## Verificar cÃ³digo
	@echo "ğŸ” Verificando cÃ³digo..."
	go vet ./...

build: deps fmt vet ## Build de la aplicaciÃ³n
	@echo "ğŸ”¨ Building aplicaciÃ³n..."
	CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o main .

run: ## Ejecutar aplicaciÃ³n localmente
	@echo "ğŸš€ Ejecutando aplicaciÃ³n..."
	go run main.go

test: ## Ejecutar tests
	@echo "ğŸ§ª Ejecutando tests..."
	go test -v ./...

clean: ## Limpiar archivos generados
	@echo "ğŸ§¹ Limpiando archivos..."
	rm -f main
	go clean

docker-build: ## Build imagen Docker
	@echo "ğŸ³ Building imagen Docker..."
	docker build -t $(DOCKER_IMAGE) .

docker-run: docker-build ## Ejecutar con Docker
	@echo "ğŸ³ Ejecutando con Docker..."
	docker run -p $(PORT):$(PORT) \
		-e ALCHEMY_API_KEY=${ALCHEMY_API_KEY} \
		-e ALCHEMY_WS_URL=${ALCHEMY_WS_URL} \
		-e PORT=$(PORT) \
		--name $(APP_NAME) \
		$(DOCKER_IMAGE)

docker-stop: ## Detener contenedor Docker
	@echo "ğŸ›‘ Deteniendo contenedor..."
	docker stop $(APP_NAME) || true
	docker rm $(APP_NAME) || true

docker-compose-up: ## Ejecutar con docker-compose
	@echo "ğŸ³ Ejecutando con docker-compose..."
	docker-compose up --build

docker-compose-down: ## Detener docker-compose
	@echo "ğŸ›‘ Deteniendo docker-compose..."
	docker-compose down

logs: ## Ver logs del contenedor
	@echo "ğŸ“‹ Mostrando logs..."
	docker logs -f $(APP_NAME)

health: ## Verificar health del servicio
	@echo "ğŸ¥ Verificando health..."
	curl -s http://localhost:$(PORT)/api/v1/health | jq .

status: ## Ver estado de monitoreo
	@echo "ğŸ“Š Verificando estado..."
	curl -s http://localhost:$(PORT)/api/v1/monitor/status | jq .

wscat-test: ## Probar WebSocket con wscat (requiere wscat instalado)
	@echo "ğŸ”Œ Probando WebSocket..."
	@echo "Conectando a ws://localhost:$(PORT)/ws/monitor/0x9d70c560cE7D6EDAaf4562E980136D21Fd0fbdc9"
	wscat -c ws://localhost:$(PORT)/ws/monitor/0x9d70c560cE7D6EDAaf4562E980136D21Fd0fbdc9

install-wscat: ## Instalar wscat para testing
	@echo "ğŸ“¦ Instalando wscat..."
	npm install -g wscat

dev: ## Modo desarrollo con auto-reload (requiere air)
	@echo "ğŸ”„ Iniciando en modo desarrollo..."
	air

install-air: ## Instalar air para auto-reload
	@echo "ğŸ“¦ Instalando air..."
	go install github.com/cosmtrek/air@latest

setup: deps install-wscat ## Setup completo para desarrollo
	@echo "âœ… Setup completo"
	@echo "Comandos Ãºtiles:"
	@echo "  make run          - Ejecutar aplicaciÃ³n"
	@echo "  make wscat-test   - Probar WebSocket"
	@echo "  make health       - Verificar health"
	@echo "  make status       - Ver estado"